<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>小瑪莉跑燈機台</title>
<style>
body{
  margin:0;
  background:#fff;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
  position:relative;
}
#container {
  border:4px solid black;
  padding:5px 10px 0px 10px;
  display:flex;
  flex-direction:column;
  align-items:center;
  margin-top:6px;
}
#top{width:358px;display:flex;justify-content:space-between;margin:5px 0px 5px 0px;}
.panel{width:170px;background:#222;color:#0f0;border:4px solid gold;padding:6px;display:flex;flex-direction:column;align-items:center;}
.panel-title{font-size:18px;margin-bottom:4px;color:#fff;}
.digits{display:flex;gap:3px;}
.digit{width:26px;height:34px;background:#111;border:2px solid #555;display:flex;justify-content:center;align-items:center;color:#f00;font-weight:bold;font-size:26px;box-shadow:0 0 6px #f00,inset 0 0 4px #600;border-radius:4px;font-family:'Courier New',monospace;}
#game{position:relative;width:348px;height:348px;border:6px solid gold;background:#fff;margin-bottom:10px;}
#grid{width:100%;height:100%;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(7,1fr);gap:1px;}
.cell{display:flex;justify-content:center;align-items:center;font-size:18px;position:relative;background:#fff;border:1px solid #000;}
.light{width:10px;height:10px;border-radius:50%;position:absolute;top:2px;right:2px;}
#center-frame{position:absolute;border:6px solid gold;width:240px;height:240px;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
#msg{position:absolute;top:calc(50% - 50px);left:50%;transform:translate(-50%,-50%);font-size:18px;font-weight:bold;pointer-events:none;text-shadow:0 0 15px #000;}
#bets{margin:10px 0;display:flex;width:356px;justify-content:space-between;gap:4px;}
.bet{display:flex;flex-direction:column;align-items:center;width:45px;border:2px solid #000;padding:2px;box-sizing:border-box;}
.fixed-number{width:100%;height:18px;background:#ccc;border:1px solid #555;font-size:14px;font-weight:bold;display:flex;justify-content:center;align-items:center;margin-bottom:2px;font-family:'Courier New',monospace;}
.bet button{
  width:100%;
  height:25px;
  background:linear-gradient(#ffffff,#dcdcdc);
  color:#000;
  border:1px solid #666;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  font-size:14px;
  margin-bottom:4px;
  box-shadow:2px 2px 0 #bbb, inset 0 1px 0 #fff;
  transition:transform 0.05s, box-shadow 0.05s;
}
.bet button:active{
  transform:translate(3px,3px);
  box-shadow:0 0 0 #666,inset 0 1px 0 #ccc;
}
.bet .count{width:90%;height:20px;line-height:20px;text-align:center;background:#111;border:2px solid #555;color:#f00;font-weight:bold;font-size:18px;box-shadow:0 0 6px #f00,inset 0 0 4px #600;border-radius:3px;font-family:'Courier New',monospace;margin-top:2px;}
#button-area{display:flex; align-items:center; margin-bottom:10px;}
#button-area button{
  width:40px;
  height:38px;
  background:linear-gradient(#ffffff,#dcdcdc);
  color:#000;
  border:1px solid #666;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
  margin-left:25px;
  margin-bottom:-10px;
  box-shadow:2px 2px 0 #bbb, inset 0 1px 0 #fff;
  transition:transform 0.05s, box-shadow 0.05s;
}
#button-area button:active{
  transform:translate(3px,3px);
  box-shadow:0 0 0 #666,inset 0 1px 0 #ccc;
}
#button-area button#start { margin-left: 50px; }
#button-area button#func1 { margin-left: 0px; }
#button-area button#func2 { margin-left: 50px; }
#button-area button#func3 { margin-left:40px; }
#button-area button#func4 { margin-left:10px; }
#top-right{position:absolute;top:10px;right:10px;text-align:center;}
#top-right button{padding:4px 8px;font-size:14px;cursor:pointer;}
#top-right div{margin-top:2px;font-size:12px;}
</style>
</head>
<body>

<div id="top-right">
  <button onclick="history.back()">返回上一頁</button>
  <div id="version">版本: V0.1</div>
  <div id="visitorCount" style="position:fixed; top:60px; right:10px; font-size:12px; color:#fffff;">訪客人數: <span id="count">0</span></div>
</div>

<div id="container">
  <div id="top">
    <div class="panel">
      <div class="panel-title">WIN</div>
      <div class="digits" id="win-digits"><div class="digit">0</div><div class="digit">0</div><div class="digit">0</div><div class="digit">0</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">CREDIT</div>
      <div class="digits" id="credit-digits"><div class="digit">0</div><div class="digit">0</div><div class="digit">2</div><div class="digit">0</div></div>
    </div>
  </div>

  <div id="game">
    <div id="grid"></div>
    <div id="center-frame"></div>
    <div id="msg"></div>

    <!-- 左燈與標籤 -->
    <div style="position:absolute; top:50%; left:40%; transform:translate(-50%,-50%); text-align:center;">
      <div id="center-left-light" class="light" style="background:#bbb; width:14px; height:14px;"></div>
      <div style="font-size:18px; color:#000; margin-top:15px;">左</div>
    </div>

    <!-- 右燈與標籤 -->
    <div style="position:absolute; top:50%; left:60%; transform:translate(-50%,-50%); text-align:center;">
      <div id="center-right-light" class="light" style="background:#bbb; width:14px; height:14px;"></div>
      <div style="font-size:18px; color:#000; margin-top:15px;">右</div>
    </div>

    <!-- 中間四位數字框（顯示押中金額） -->
    <div id="center-win-digits" style="position:absolute; top:calc(50% + 60px); left:50%; transform:translate(-50%,-50%); display:flex; gap:3px;">
      <div class="digit">0</div>
      <div class="digit">0</div>
      <div class="digit">0</div>
      <div class="digit">0</div>
    </div>

  </div>

  <div id="button-area">
    <button id="func1">投幣10元</button>
    <button id="func2">轉到錢包</button>
    <button id="func3">選左</button>
    <button id="func4">選右</button>
    <button id="start">開始</button>
  </div>

  <div id="bets"></div>
</div>

<script>
// Web Audio 播放 coin07.mp3
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
let coinBuffer=null;
fetch('coin07.mp3').then(r=>r.arrayBuffer()).then(b=>audioCtx.decodeAudioData(b)).then(buf=>coinBuffer=buf);
function playCoin(){
  if(!coinBuffer) return;
  if(audioCtx.state==='suspended') audioCtx.resume();
  const src = audioCtx.createBufferSource();
  src.buffer = coinBuffer;
  src.connect(audioCtx.destination);
  src.start();
}

//訪客計數器
let totalCount = parseInt(localStorage.getItem('visitorCount') || '0');
if (!sessionStorage.getItem('visited')) {
    totalCount++;
    localStorage.setItem('visitorCount', totalCount);
    sessionStorage.setItem('visited', 'true');
}
document.getElementById('count').textContent = totalCount.toString().padStart(5, '0');

// 遊戲邏輯
const grid=document.getElementById('grid'); 
const msg=document.getElementById('msg');
let credit=20, win=0;
let bets={}, betCounts={}; 
let spinning=false, pos=0;
let centerWin=0;
let flashingInterval=null;

function updateDigits(id,val){
  const s=val.toString().padStart(4,'0'); 
  const d=document.getElementById(id).children; 
  for(let i=0;i<4;i++) d[i].textContent=s[i];
}

// 建立格子與下注按鈕
const letters=Array(7).fill(0).map(()=>Array(7).fill(''));
letters[0][0]='A';letters[6][6]='A'; letters[0][1]='B'; letters[6][5]='B';
letters[0][2]='C'; letters[0][5]='C'; letters[2][6]='C'; letters[5][6]='C';
letters[6][4]='C';letters[6][1]='C'; letters[4][0]='C'; letters[1][0]='C';
letters[0][3]='D'; letters[0][4]='E'; letters[2][0]='E'; letters[4][6]='E';
letters[6][2]='E'; letters[0][6]='F'; letters[6][0]='F'; letters[1][6]='G';
letters[6][3]='H'; letters[5][0]='I';

let cells=[]; 
for(let r=0;r<7;r++){
  for(let c=0;c<7;c++){
    const d=document.createElement('div'); 
    d.className='cell'; 
    d.dataset.letter=letters[r][c]; 
    d.textContent=letters[r][c];
    const l=document.createElement('div'); 
    l.className='light';
    if(r>=1 && r<=5 && c>=1 && c<=5){
        d.dataset.center='true';
        d.style.border='1px solid #fff';
        d.style.color='#fff';
        l.style.background='#fff';
    } else { l.style.background='#bbb'; }
    d.appendChild(l); 
    grid.appendChild(d); 
    cells.push({el:d});
  }
}

let order=[]; for(let c=0;c<7;c++) order.push(cells[c]); for(let r=1;r<6;r++) order.push(cells[r*7+6]); for(let c=6;c>=0;c--) order.push(cells[6*7+c]); for(let r=5;r>0;r--) order.push(cells[r*7]);

const buttonConfig=[{ch:'E',mult:5},{ch:'G',mult:20},{ch:'I',mult:30},{ch:'H',mult:40},{ch:'D',mult:50},{ch:'B',mult:20},{ch:'F',mult:15},{ch:'A',mult:10},{ch:'C',mult:2}];
const betBox=document.getElementById('bets');
buttonConfig.forEach(cfg=>{
  bets[cfg.ch]=0; betCounts[cfg.ch]=0;
  const wrap=document.createElement('div'); wrap.className='bet';
  const fixed=document.createElement('div'); fixed.className='fixed-number'; fixed.textContent=cfg.mult;
  const btn=document.createElement('button'); btn.textContent=cfg.ch;
  const count=document.createElement('div'); count.className='count'; count.textContent='0';

  btn.onclick=()=>{ 
    playCoin(); // 播放音效
    if(spinning) return;
    if(betCounts[cfg.ch]>=9) return; 
    if(credit <= 0){
      msg.style.color = '#f00';
      msg.textContent = '你破產了';
      setTimeout(()=>{ msg.textContent = ''; },3000);
      return;
    }
    betCounts[cfg.ch]++; 
    bets[cfg.ch]++; 
    credit--; 
    count.textContent=betCounts[cfg.ch]; 
    updateDigits('credit-digits', credit);

    // 將中間金額加到 WIN
    win += centerWin;
    updateDigits('win-digits', win);

    // 停止左右閃燈
    if(flashingInterval){
        clearInterval(flashingInterval);
        flashingInterval = null;
        document.getElementById('center-left-light').style.background = '#bbb';
        document.getElementById('center-right-light').style.background = '#bbb';
    }

    // 清空中間金額
    centerWin = 0;
    updateDigits('center-win-digits', centerWin);
  };
  wrap.append(fixed,btn,count); 
  betBox.appendChild(wrap);
});

// 投幣
document.getElementById('func1').onclick = () => {
    playCoin(); // 播放音效
    credit += 10;
    updateDigits('credit-digits', credit);
};

// 轉到錢包
document.getElementById('func2').onclick = () => {
    credit += win;
    win = 0;
    updateDigits('credit-digits', credit);
    updateDigits('win-digits', win);
};

// 跑燈
function spin(){
  if(spinning) return;
  spinning=true;
  const minDelay=50; const maxDelay=300;
  const totalSteps = order.length*4 + Math.floor(Math.random()*order.length);
  let step=0; 
  const accelSteps = totalSteps*0.25; 
  const decelSteps = totalSteps*0.25;

  function nextStep(){
    order.forEach((o,idx)=>{
      const l=o.el.querySelector('.light');
      if(o.el.dataset.center) l.style.background='#fff';
      else l.style.background=idx===pos?'#f00':'#bbb';
    });
    step++;
    if(step>=totalSteps){
      const stop = order[pos];
      const letter = stop.el.dataset.letter;
      const cfg = buttonConfig.find(b=>b.ch===letter);
      const gain = cfg?bets[letter]*cfg.mult:0;

      if(gain>0){
        centerWin = gain;
        updateDigits('center-win-digits', centerWin);

        msg.style.color='#ff0'; 
        msg.textContent=`押中 ${letter} +${gain}`;
        setTimeout(()=>{ msg.textContent=''; }, 3000);

        // 開始左右燈閃爍
        const leftLight = document.getElementById('center-left-light');
        const rightLight = document.getElementById('center-right-light');
        let onLeft = true;
        flashingInterval = setInterval(()=>{
          if(onLeft){
            leftLight.style.background='#f00';
            rightLight.style.background='#bbb';
          } else {
            leftLight.style.background='#bbb';
            rightLight.style.background='#f00';
          }
          onLeft = !onLeft;
        }, 300);

      } else {
        centerWin=0;
        updateDigits('center-win-digits', centerWin);
        msg.style.color='#f00';
        msg.textContent='沒中';
        setTimeout(()=>{ msg.textContent=''; },3000);
      }

      document.querySelectorAll('.count').forEach(c=>c.textContent='0'); 
      for(let k in bets){bets[k]=0; betCounts[k]=0;} 
      document.getElementById('start').disabled = true;
      setTimeout(()=>{document.getElementById('start').disabled=false;},5000);
      spinning=false;
      return;
    }

    let currentDelay;
    if(step<accelSteps){ currentDelay = maxDelay - (maxDelay-minDelay)*(step/accelSteps); } 
    else if(step>totalSteps-decelSteps){ const s = step-(totalSteps-decelSteps); currentDelay = minDelay + (maxDelay-minDelay)*(s/decelSteps); } 
    else { currentDelay = minDelay; }

    pos = (pos+1)%order.length;
    setTimeout(nextStep,currentDelay);
  }
  nextStep();
}

// 開始
document.getElementById('start').onclick=()=>{ if(spinning||Object.values(bets).every(v=>v===0)) return; spin(); };

// 選左/右按鈕
function stopFlashing(selected){
  if(!flashingInterval) return;
  clearInterval(flashingInterval);
  flashingInterval=null;

  const leftLight = document.getElementById('center-left-light');
  const rightLight = document.getElementById('center-right-light');

  let finalSide = Math.random()<0.5?'left':'right';
  let steps = 6;
  let count=0;

  function slowStep(){
    if(count>=steps){
      leftLight.style.background = finalSide==='left'?'#f00':'#bbb';
      rightLight.style.background = finalSide==='right'?'#f00':'#bbb';

      if(finalSide===selected){
        centerWin *=2;
        updateDigits('center-win-digits', centerWin);
        msg.style.color='#ff0';
        msg.textContent=`選中! 獎金 x2`;
        setTimeout(()=>{ msg.textContent=''; },3000);

        // 中獎後再次啟動左右閃爍
        let onLeft = true;
        flashingInterval = setInterval(()=>{
          if(onLeft){
            leftLight.style.background='#f00';
            rightLight.style.background='#bbb';
          } else {
            leftLight.style.background='#bbb';
            rightLight.style.background='#f00';
          }
          onLeft = !onLeft;
        }, 300);

      } else {
        centerWin=0;
        updateDigits('center-win-digits', centerWin);
        msg.style.color='#f00';
        msg.textContent=`沒中`;
        setTimeout(()=>{ msg.textContent=''; },3000);
      }
      return;
    }
    if(count%2===0){
      leftLight.style.background='#f00'; rightLight.style.background='#bbb';
    } else{
      leftLight.style.background='#bbb'; rightLight.style.background='#f00';
    }
    count++;
    setTimeout(slowStep,200);
  }
  slowStep();
}

document.getElementById('func3').onclick=()=>{ stopFlashing('left'); }
document.getElementById('func4').onclick=()=>{ stopFlashing('right'); }

</script>
</body>
</html>
