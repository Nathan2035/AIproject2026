<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>小瑪莉跑燈機台</title>
<style>
body{margin:0;background:#fff;font-family:Arial;display:flex;flex-direction:column;align-items:center;}
#top{width:348px;display:flex;justify-content:space-between;margin:10px 0;}
.panel{width:170px;background:#222;color:#0f0;border:4px solid gold;padding:6px;display:flex;flex-direction:column;align-items:center;}
.panel-title{font-size:18px;margin-bottom:4px;color:#fff;}
.digits{display:flex;gap:3px;}
.digit{width:26px;height:34px;background:#111;border:2px solid #555;display:flex;justify-content:center;align-items:center;color:#f00;font-weight:bold;font-size:26px;box-shadow:0 0 6px #f00,inset 0 0 4px #600;border-radius:4px;font-family:'Courier New',monospace;}
#game{position:relative;width:348px;height:348px;border:6px solid gold;background:#fff;margin-bottom:10px;}
#grid{width:100%;height:100%;display:grid;grid-template-columns:repeat(7,1fr);grid-template-rows:repeat(7,1fr);gap:1px;}
.cell{display:flex;justify-content:center;align-items:center;font-size:18px;position:relative;background:#fff;border:1px solid #000;}
.light{width:10px;height:10px;border-radius:50%;position:absolute;top:2px;right:2px;}
#center-frame{position:absolute;border:6px solid gold;width:240px;height:240px;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}
#msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:36px;font-weight:bold;pointer-events:none;text-shadow:0 0 15px #000;}
#bets{margin:10px 0;display:flex;width:356px;justify-content:space-between;gap:4px;}
.bet{display:flex;flex-direction:column;align-items:center;width:45px;border:2px solid #000;padding:2px;box-sizing:border-box;}
.fixed-number{width:100%;height:18px;background:#ccc;border:1px solid #555;font-size:14px;font-weight:bold;display:flex;justify-content:center;align-items:center;margin-bottom:2px;font-family:'Courier New',monospace;}
.bet button{width:100%;height:25px;background:linear-gradient(#ffffff,#dcdcdc);color:#000;border:1px solid #666;border-radius:6px;cursor:pointer;font-weight:bold;font-size:14px;margin-bottom:4px;box-shadow:2px 2px 0 #bbb, inset 0 1px 0 #fff;transition:transform 0.05s, box-shadow 0.05s;}
.bet button:active{transform:translate(3px,3px);box-shadow:0 0 0 #666,inset 0 1px 0 #ccc;}
.bet .count{width:90%;height:20px;line-height:20px;text-align:center;background:#111;border:2px solid #555;color:#f00;font-weight:bold;font-size:18px;box-shadow:0 0 6px #f00,inset 0 0 4px #600;border-radius:3px;font-family:'Courier New',monospace;margin-top:2px;}
#start{width:120px;height:40px;background:#0a0;border:none;color:#fff;font-weight:bold;cursor:pointer;margin-bottom:10px;}
</style>
</head>
<body>
<div id="top">
<div class="panel"><div class="panel-title">WIN</div><div class="digits" id="win-digits"><div class="digit">0</div><div class="digit">0</div><div class="digit">0</div><div class="digit">0</div></div></div>
<div class="panel"><div class="panel-title">CREDIT</div><div class="digits" id="credit-digits"><div class="digit">5</div><div class="digit">0</div><div class="digit">0</div><div class="digit">0</div></div></div>
</div>
<div id="game"><div id="grid"></div><div id="center-frame"></div><div id="msg"></div></div>
<div id="bets"></div><button id="start">START</button>

<script>
const grid=document.getElementById('grid'); 
const msg=document.getElementById('msg');
let credit=5000, win=0; 
let bets={}, betCounts={}; 
let spinning=false, pos=0;

function updateDigits(id,val){
  const s=val.toString().padStart(4,'0'); 
  const d=document.getElementById(id).children; 
  for(let i=0;i<4;i++) d[i].textContent=s[i];
}

// 建立格子
const letters=Array(7).fill(0).map(()=>Array(7).fill(''));
letters[0][0]='A';letters[6][6]='A'; letters[0][1]='B'; letters[6][5]='B';
letters[0][2]='C'; letters[0][5]='C'; letters[2][6]='C'; letters[5][6]='C';
letters[6][4]='C';letters[6][1]='C'; letters[4][0]='C'; letters[1][0]='C';
letters[0][3]='D'; letters[0][4]='E'; letters[2][0]='E'; letters[4][6]='E';
letters[6][2]='E'; letters[0][6]='F'; letters[6][0]='F'; letters[1][6]='G';
letters[6][3]='H'; letters[5][0]='I';

let cells=[]; 
for(let r=0;r<7;r++){
  for(let c=0;c<7;c++){
    const d=document.createElement('div'); 
    d.className='cell'; 
    d.dataset.letter=letters[r][c]; 
    d.textContent=letters[r][c];
    const l=document.createElement('div'); 
    l.className='light';
    if(r>=1&&r<=5 && c>=1&&c<=5){d.dataset.center='true';d.style.border='1px solid #fff';d.style.color='#fff'; l.style.background='#fff';}
    else { l.style.background='#bbb'; } // 初始灰色燈
    d.appendChild(l); 
    grid.appendChild(d); 
    cells.push({el:d});
  }
}

let order=[];
for(let c=0;c<7;c++) order.push(cells[c]);
for(let r=1;r<6;r++) order.push(cells[r*7+6]);
for(let c=6;c>=0;c--) order.push(cells[6*7+c]);
for(let r=5;r>0;r--) order.push(cells[r*7]);

const buttonConfig=[
  {ch:'E',mult:5},{ch:'G',mult:20},{ch:'I',mult:30},
  {ch:'H',mult:40},{ch:'D',mult:50},{ch:'B',mult:20},
  {ch:'F',mult:15},{ch:'A',mult:10},{ch:'C',mult:2}
];

const betBox=document.getElementById('bets');
buttonConfig.forEach(cfg=>{
  bets[cfg.ch]=0; betCounts[cfg.ch]=0;
  const wrap=document.createElement('div'); wrap.className='bet';
  const fixed=document.createElement('div'); fixed.className='fixed-number'; fixed.textContent=cfg.mult;
  const btn=document.createElement('button'); btn.textContent=cfg.ch;
  const count=document.createElement('div'); count.className='count'; count.textContent='0';
  btn.onclick=()=>{
    if(spinning||credit<=0||betCounts[cfg.ch]>=9)return; 
    betCounts[cfg.ch]++; bets[cfg.ch]++; credit--; count.textContent=betCounts[cfg.ch]; 
    updateDigits('credit-digits',credit);
    playTick();
  };
  wrap.append(fixed,btn,count); 
  betBox.appendChild(wrap);
});

// Web Audio API 音效，音量縮小50%
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let tickBuffer = null;

fetch('coin07.mp3')
  .then(r=>r.arrayBuffer())
  .then(data => audioCtx.decodeAudioData(data))
  .then(buf => tickBuffer = buf);

function playTick(){
  if(!tickBuffer) return;
  const source = audioCtx.createBufferSource();
  source.buffer = tickBuffer;
  const gainNode = audioCtx.createGain();
  gainNode.gain.value = 0.5; // 音量 50%
  source.connect(gainNode).connect(audioCtx.destination);
  source.start();
}

// 跑燈
function spin(){
  if(spinning) return;
  spinning=true;
  const minDelay=50; const maxDelay=300;
  const totalSteps = order.length*4 + Math.floor(Math.random()*order.length);
  let step=0; 
  const accelSteps = totalSteps*0.25; 
  const decelSteps = totalSteps*0.25;

  function nextStep(){
    order.forEach((o,idx)=>{
      const l=o.el.querySelector('.light');
      if(o.el.dataset.center) l.style.background='#fff';
      else l.style.background=idx===pos?'#f00':'#bbb';
    });
    playTick();
    step++;
    if(step>=totalSteps){
      spinning=false;
      const stop = order[pos];
      const letter = stop.el.dataset.letter;
      const cfg = buttonConfig.find(b=>b.ch===letter);
      const gain = cfg?bets[letter]*cfg.mult:0;
      win+=gain; 
      msg.style.color=gain?'#ff0':'#f00'; 
      msg.textContent=gain?`押中 ${letter} +${gain}`:`沒中`; 
      updateDigits('win-digits',win);
      setTimeout(()=>{
        for(let k in bets){bets[k]=0; betCounts[k]=0;} 
        document.querySelectorAll('.count').forEach(c=>c.textContent='0'); 
        msg.textContent='';
      },3000);
      return;
    }

    // 加速與減速
    let currentDelay;
    if(step<accelSteps){ currentDelay = maxDelay - (maxDelay-minDelay)*(step/accelSteps); } 
    else if(step>totalSteps-decelSteps){ const s = step-(totalSteps-decelSteps); currentDelay = minDelay + (maxDelay-minDelay)*(s/decelSteps); } 
    else { currentDelay = minDelay; }

    pos = (pos+1)%order.length;
    setTimeout(nextStep,currentDelay);
  }

  nextStep();
}

// START 按鈕先啟動 audioCtx，再開始跑燈
document.getElementById('start').onclick=()=>{
  audioCtx.resume().then(()=>{
    if(spinning||Object.values(bets).every(v=>v===0)) return; 
    spin();
  });
};
</script>
</body>
</html>
