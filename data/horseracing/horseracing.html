<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è³½è±¬éŠæˆ²</title>
<style>
/* --- åŸæœ¬ CSS ä¿ç•™ --- */
body{font-family:Segoe UI,Arial;background:#fff;color:#333;padding:20px;text-align:center;}
#backBtn{position:fixed;top:10px;right:10px;padding:6px 12px;font-size:14px;background:#fff;border:2px solid #ccc;border-radius:6px;cursor:pointer;color:#333;z-index:9999;box-shadow:2px 2px 5px rgba(0,0,0,0.3);transition: all 0.1s ease;}
#backBtn:active{transform: translateY(2px);box-shadow:1px 1px 3px rgba(0,0,0,0.3);}
#controls{margin-bottom:20px;}
.bet-box{display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #ffd700;border-radius:8px;}
.bet-row{display:flex;justify-content:center;align-items:center;margin-bottom:10px;gap:15px;flex-wrap: wrap;}
.bet-row label{margin-right:5px;font-size:14px;}
.bet-row select{padding:5px 8px;font-size:14px;background-color:#bbb;color:#000;border:none;border-radius:2px;cursor:pointer;}
#button-row{margin-top:10px;display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap: wrap;}
#track{position:relative;width:900px;height:350px;margin:-10px auto 10px;border:4px solid #c9a44c;background:linear-gradient(#1f5f2a,#2e7d32);overflow:hidden;}
.lane{position:absolute;left:0;width:100%;height:43.75px;border-bottom:1px solid rgba(255,255,255,.25);}
.horse{position:absolute;right:10px;font-size:32px;transform-origin: center bottom;}
.number{position:absolute;top:16px;left:18px;font-size:14px;font-weight:bold;color:#000;}
.crown{position:absolute;top:-6px;left:50%;transform:translateX(-50%);font-size:20px;}
#finishLine{position:absolute;left:50px;top:0;width:4px;height:100%;background:red;}
#startLine{position:absolute;right:50px;top:0;width:4px;height:100%;background:blue;display:block;}
#countdown{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:96px;font-weight:bold;color:#ffd700;text-shadow:4px 4px 8px #000;display:none;pointer-events:none;}
#message{font-size:28px;color:#ffd700;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-shadow:2px 2px 4px #000;text-align:left;pointer-events:none;white-space:pre-line;opacity:1;transition: opacity 1s ease;}
#betMessage{font-size:20px;color:#ffeb3b;position:absolute;top:10%;left:50%;transform:translateX(-50%);text-shadow:2px 2px 4px #000;pointer-events:none;white-space:pre-line;opacity:1;transition: opacity 1s ease;}
table{width:900px;max-width:900px;margin:-6px auto;border-collapse:collapse;text-align:center;table-layout:fixed;}
th,td{border:2px solid #ffd700;padding:0;height:25px;line-height:25px;font-size:85%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
th{background:#bbb;}
button{padding:6px 12px;font-size:14px;background:#fff;border:2px solid #ccc;border-radius:6px;cursor:pointer;color:#333;box-shadow:2px 2px 5px rgba(0,0,0,0.3);transition: all 0.1s ease;}
button:active{transform: translateY(2px);box-shadow:1px 1px 3px rgba(0,0,0,0.3);}
button:disabled{background:#eee;cursor:not-allowed;color:#999;box-shadow:none;}
.chipDisplay{display:inline-block;min-width:50px;padding:4px 6px;border:2px solid #ffb700;border-radius:4px;text-align:center;background-color:#fff;color:#333;font-size:18px;}
.highlight{background-color:#bbb;padding:2px 4px;border-radius:2px;}
</style>
</head>
<body>

<button id="backBtn">å›åˆ°ä¸Šä¸€é </button>
<div id="version" style="position:fixed; top:50px; right:15px; font-size:14px; color:#333333;">ç‰ˆæœ¬: V0.03</div>

<div id="controls">
    <div class="bet-row">
        <span style="margin-right:10px; color:#333; align-self:center; font-size:30px">è³½è±¬éŠæˆ²ç°¡å–®ç‰ˆ</span>
        <div class="bet-box">
            <label>George :</label>
            <select id="betSelect"></select>
            <label>é‡‘é¡ :</label>
            <select id="chipSelect1">
                <option value="100">100å…ƒ</option>
                <option value="500">500å…ƒ</option>
                <option value="1000">1000å…ƒ</option>
            </select>
        </div>
        <div class="bet-box">
            <label>Mary :</label>
            <select id="betSelect2"></select>
            <label>é‡‘é¡ :</label>
            <select id="chipSelect2">
                <option value="100">100å…ƒ</option>
                <option value="500">500å…ƒ</option>
                <option value="1000">1000å…ƒ</option>
            </select>
        </div>
    </div>
    <div id="button-row">
        <label style="font-size:14px;">è«‹å…ˆé¸æ“‡ä¸Šé¢ <span class="highlight">ç·¨è™Ÿ</span> åŠ <span class="highlight">é‡‘é¡</span> å†æŒ‰ä¸‹æ³¨</label>
        <span>ç›®å‰ç±Œç¢¼ : <span id="playerChips" class="chipDisplay">05000</span> å…ƒ</span>
        <button id="placeBetBtn">ä¸‹æ³¨</button>
        <button id="startBtn" disabled>é–‹å§‹æ¯”è³½</button>
        <button id="rematchBtn" disabled>é‡æ–°æ¯”è³½</button>
        <button id="statsBtn">æ¯”è³½è³‡æ–™çµ±è¨ˆ</button>
        <button id="resetBtn">å…¨éƒ¨é‡è¨­</button>
    </div>
</div>

<div id="track">
    <div id="countdown"></div>
    <div id="finishLine"></div>
    <div id="startLine"></div>
    <div id="message"></div>
    <div id="betMessage"></div>
</div>

<table id="resultsTable">
<tbody>
<tr id="rankRow">
<th>å† è»</th><th>äºè»</th><th>å­£è»</th><th>ç¬¬4å</th><th>ç¬¬5å</th><th>ç¬¬6å</th><th>ç¬¬7å</th><th>ç¬¬8å</th>
</tr>
<tr id="horseRow">
<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
</tr>
<tr id="timeRow">
<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
</tr>
</tbody>
</table>

<script>
const HORSE_COUNT=8;
let playerChips=5000;
let horses=[],rankingCounter=0,startTime=null,animationId=null,lastTs=null,ragingHorseId=null,raceHistory=[],betPlaced=false,statsVisible=false,currentBets=[],currentChips=[];

const betSelect=document.getElementById('betSelect');
const betSelect2=document.getElementById('betSelect2');
const chipSelect1=document.getElementById('chipSelect1');
const chipSelect2=document.getElementById('chipSelect2');
const playerChipsEl=document.getElementById('playerChips');
const countdownEl=document.getElementById('countdown');
const horseRow=document.getElementById('horseRow');
const timeRow=document.getElementById('timeRow');
const messageEl=document.getElementById('message');
const betMessageEl=document.getElementById('betMessage');
const startBtn=document.getElementById('startBtn');
const rematchBtn=document.getElementById('rematchBtn');
const resetBtn=document.getElementById('resetBtn');
const statsBtn=document.getElementById('statsBtn');
const placeBetBtn=document.getElementById('placeBetBtn');
const track=document.getElementById('track');
const startLine=document.getElementById('startLine');
const backBtn=document.getElementById('backBtn');

backBtn.onclick=()=>{window.history.back();};

// AudioContext èˆ‡ buffer
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
const audioBuffers={};
async function loadAudio(name,url){const resp=await fetch(url);const arrBuf=await resp.arrayBuffer();audioBuffers[name]=await audioCtx.decodeAudioData(arrBuf);}
function playSound(name){if(audioBuffers[name]){const src=audioCtx.createBufferSource();src.buffer=audioBuffers[name];src.connect(audioCtx.destination);src.start(0);}}
loadAudio('start','correct_answer2.mp3');loadAudio('win','coin07.mp3');loadAudio('champion','cheers2.mp3');

function updateChipsDisplay(){playerChipsEl.textContent=playerChips.toString().padStart(5,'0');}

function init(){
    track.querySelectorAll('.lane,.horse').forEach(e=>e.remove());
    horseRow.querySelectorAll('td').forEach(td=>td.textContent='');
    timeRow.querySelectorAll('td').forEach(td=>td.textContent='');
    betSelect.innerHTML='';betSelect2.innerHTML='';
    messageEl.textContent='';messageEl.style.opacity=1;
    betMessageEl.style.opacity=0;
    horses=[];rankingCounter=0;startTime=null;lastTs=null;
    startBtn.disabled=true;rematchBtn.disabled=true;placeBetBtn.disabled=false;
    betPlaced=false;ragingHorseId=Math.floor(Math.random()*HORSE_COUNT)+1;

    const laneHeight=350/HORSE_COUNT;
    for(let i=0;i<HORSE_COUNT;i++){
        const lane=document.createElement('div');lane.className='lane';lane.style.top=i*laneHeight+'px';track.appendChild(lane);
        const horse=document.createElement('div');horse.className='horse';horse.style.top=i*laneHeight+2+'px';horse.innerHTML='ğŸ–<div class="number">'+(i+1)+'</div>';track.appendChild(horse);
        horses.push({id:i+1,x:10,speed:((Math.random()*2+1.5)*0.5)*0.8,finished:false,el:horse,tilt:0,tiltDirection:1,finishTime:0,isRaging:false,rageTime:0,rageSpeed:0});
        const opt1=document.createElement('option');opt1.value=i+1;opt1.textContent=(i+1)+'è™Ÿè±¬';betSelect.appendChild(opt1);
        const opt2=document.createElement('option');opt2.value=i+1;opt2.textContent=(i+1)+'è™Ÿè±¬';betSelect2.appendChild(opt2);
    }
    startLine.style.display='block';
    updateChipsDisplay();
}

function showBetMessage(msg){betMessageEl.textContent=msg;betMessageEl.style.opacity=1;setTimeout(()=>{betMessageEl.style.opacity=0;},3000);}

placeBetBtn.onclick=()=>{
    if(betPlaced) return;
    const bet1=parseInt(betSelect.value),bet2=parseInt(betSelect2.value);
    if(bet1===bet2){showBetMessage('å…©å€‹ä¸‹æ³¨ä¸èƒ½é¸åŒä¸€éš»è±¬');return;}
    const chip1=parseInt(chipSelect1.value),chip2=parseInt(chipSelect2.value);
    if(playerChips<chip1+chip2){showBetMessage('ç±Œç¢¼ä¸è¶³');return;}
    playerChips-=(chip1+chip2);updateChipsDisplay();currentBets=[bet1,bet2];currentChips=[chip1,chip2];
    showBetMessage(`å·²ä¸‹æ³¨ï¼GeorgeæŠ¼${bet1}è™Ÿ${chip1}å…ƒï¼ŒMaryæŠ¼${bet2}è™Ÿ${chip2}å…ƒ`);
    startBtn.disabled=false;placeBetBtn.disabled=true;betPlaced=true;
};

startBtn.onclick=()=>{if(animationId||!betPlaced) return;startBtn.disabled=true;rematchBtn.disabled=false;startCountdown();};

function startCountdown(){
    let count=3;countdownEl.style.display='block';startLine.style.display='block';
    function showCount(){if(count>0){countdownEl.textContent=count;playSound('start');count--;setTimeout(showCount,1000);}else if(count===0){countdownEl.textContent='GO';playSound('start');count--;setTimeout(()=>{countdownEl.style.display='none';startLine.style.display='none';startTime=performance.now();lastTs=null;animationId=requestAnimationFrame(update);},1000);}}
    showCount();
}

function update(ts){
    if(lastTs===null) lastTs=ts;
    const delta=(ts-lastTs)/1000;lastTs=ts;
    horses.forEach(h=>{
        if(h.finished) return;
        if(h.id===ragingHorseId&&!h.isRaging&&Math.random()<0.005){h.isRaging=true;h.rageTime=0.5;h.rageSpeed=(1+Math.random()*2)*0.8;h.el.style.fontSize="36px";}
        let actualSpeed=h.speed;
        if(h.isRaging){actualSpeed+=h.rageSpeed;h.rageTime-=delta;if(h.rageTime<=0){h.isRaging=false;h.el.style.fontSize="32px";}}
        h.x+=actualSpeed*delta*120;h.el.style.right=h.x+'px';
        h.tilt+=0.4*h.tiltDirection;if(h.tilt>=10) h.tiltDirection=-1;if(h.tilt<=-10) h.tiltDirection=1;h.el.style.transform=`rotate(${h.tilt}deg)`;
        if(h.x>=track.clientWidth-50&&!h.finished){h.finished=true;h.finishTime=((ts-startTime)/1000).toFixed(2);horseRow.cells[rankingCounter].textContent=h.id;timeRow.cells[rankingCounter].textContent=h.finishTime+'s';
        if(rankingCounter===0){const crown=document.createElement('div');crown.className='crown';crown.textContent='ğŸ‘‘';h.el.appendChild(crown);playSound('champion');}rankingCounter++;}
    });
    if(horses.every(h=>h.finished)){saveRaceResult();handleBetResults();cancelAnimationFrame(animationId);animationId=null;lastTs=null;return;}
    animationId=requestAnimationFrame(update);
}

function saveRaceResult(){raceHistory.push(horses.slice().sort((a,b)=>a.finishTime-b.finishTime).map(h=>h.id));}

function handleBetResults(){
    const firstThree=[parseInt(horseRow.cells[0].textContent),parseInt(horseRow.cells[1].textContent),parseInt(horseRow.cells[2].textContent)];
    let resultMsgs=[];
    currentBets.forEach((bet,idx)=>{
        const chip=currentChips[idx];let reward=0;let msg='';const name=idx===0?'George':'Mary';
        if(bet===firstThree[0]){reward=chip*3;playerChips+=reward;msg=`${name}æŠ¼ä¸­å† è» çé‡‘ ${reward}å…ƒ`;playSound('win');}
        else if(bet===firstThree[1]){reward=chip*2;playerChips+=reward;msg=`${name}æŠ¼ä¸­äºè» çé‡‘ ${reward}å…ƒ`;}
        else if(bet===firstThree[2]){reward=chip*1;playerChips+=reward;msg=`${name}æ‰“å¹³ çé‡‘ ${reward}å…ƒ`;}
        else{msg=`${name}æ²’æœ‰æŠ¼ä¸­`;}
        resultMsgs.push(msg);
    });
    updateChipsDisplay();messageEl.innerHTML=resultMsgs.join('<br>');messageEl.style.opacity=1;currentChips=[];
}

rematchBtn.onclick=()=>{init();};
resetBtn.onclick=()=>{playerChips=5000;init();};

statsBtn.onclick=()=>{
    if(!statsVisible){
        if(raceHistory.length===0){messageEl.textContent="å°šç„¡æ¯”è³½è³‡æ–™ï¼";messageEl.style.opacity=1;setTimeout(()=>{messageEl.style.opacity=0;},3000);return;}
        const stats={};for(let i=1;i<=HORSE_COUNT;i++) stats[i]={champ:0,second:0,third:0,last:0};
        raceHistory.forEach(result=>{stats[result[0]].champ++;stats[result[1]].second++;stats[result[2]].third++;stats[result[result.length-1]].last++;});
        let msg="";for(let i=1;i<=HORSE_COUNT;i++){msg+=`${i}è™Ÿè±¬ å† è»:${stats[i].champ} äºè»:${stats[i].second} å­£è»:${stats[i].third} æœ€å¾Œ:${stats[i].last}\n`;}
        messageEl.textContent=msg;messageEl.style.opacity=1;statsBtn.textContent="é—œé–‰è³‡æ–™é¡¯ç¤º";statsVisible=true;
    }else{
        messageEl.textContent='';messageEl.style.opacity=1;statsBtn.textContent="æ¯”è³½è³‡æ–™çµ±è¨ˆ";statsVisible=false;
    }
};

init();
</script>
</body>
</html>
