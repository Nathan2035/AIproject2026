<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>台灣麻將對戰</title>
<style>
    :root { --tile-w: 44px; --tile-h: 62px; }
    
    body { 
        font-family: "Microsoft JhengHei", sans-serif; 
        background: #2c3e50; margin: 0; padding: 0; color: white; 
        overflow: hidden; touch-action: manipulation;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        height: 100vh; width: 100vw;
    }

    #game-container {
        display: flex; flex-direction: column; align-items: center;
        transform-origin: top center; padding: 10px;
    }

    #table {
        width: 950px; height: 580px; background: #27ae60; border: 12px solid #8b5e3c; border-radius: 25px;
        position: relative; box-shadow: inset 0 0 50px rgba(0,0,0,0.5); box-sizing: border-box;
    }

    #backBtn { position:fixed; top:10px; right:10px; padding:8px 15px; font-size:14px; background:#fff; border:2px solid #ccc; border-radius:6px; cursor:pointer; color:#333; z-index:9999; }
    
    #dealerHand { display: flex; position: absolute; height: var(--tile-h); top: 15px; left: 50%; transform: translateX(calc(-50% + 30px)); width: 800px; justify-content: center; }
    #playerHand { display: flex; position: absolute; height: var(--tile-h); bottom: 15px; left: 50%; transform: translateX(-50%); width: 800px; justify-content: center; }
    
    .hand img, .discardTile, .meldGroup img { 
        width: var(--tile-w); height: var(--tile-h); position: absolute; 
        cursor: pointer; transition: 0.1s; background: white; 
        border: 1px solid #333; border-radius: 4px; -webkit-user-drag: none;
        will-change: transform, opacity;
        image-rendering: -webkit-optimize-contrast;
        backface-visibility: hidden;
    }
    .hand img:active { transform: translateY(-20px); z-index: 100; }

    #discardArea { position: absolute; top: 130px; left: 50%; transform: translateX(-50%); width: 650px; height: 180px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 4px; padding: 5px; }
    .discardTile { width: 30px; height: 42px; border: 1px solid #333; background: white; pointer-events: none; position: relative; }

    #playerMeldArea { position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; width: 850px; }
    #dealerMeldArea { position: absolute; top: 85px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; width: 850px; flex-direction: row-reverse; }
    .meldGroup { display: flex; gap: 2px; background: rgba(0,0,0,0.2); padding: 3px; border-radius: 5px; }
    .meldGroup img { width: 35px; height: 50px; position: relative; }

  .messageLayer { 
    position: absolute; 
    color: #ffea00; 
    font-size: 26px; 
    font-weight: bold; 
    text-shadow: 3px 3px 5px #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    opacity: 0; 
    transition: 0.4s; 
    z-index: 1000; 
    width: 100%; 
    text-align: center; 
    pointer-events: none; 
}
    
    #controls { 
        width: 950px; margin-top: 10px; background: #ecf0f1; padding: 15px; border-radius: 15px; 
        color: #333; display: flex; align-items: center; gap: 10px; justify-content: center; box-sizing: border-box;
    }
    
    button { padding: 12px 18px; border-radius: 10px; border: none; background: #2980b9; color: white; font-weight: bold; cursor: pointer; font-size: 18px; min-width: 80px; }
    button.disabled { background: #bdc3c7; cursor: not-allowed; opacity: 0.5; }
    button:active:not(.disabled) { background: #1a5276; transform: scale(0.95); }

    #chiChoices { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px; border-radius: 20px; display: none; gap: 15px; z-index: 2000; border: 2px solid #ffea00; }
    .chi-group { display: flex; gap: 5px; cursor: pointer; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); }
</style>
</head>
<body>

<div id="top-right">
<button id="backBtn">回到上一頁</button>
<div id="version" style="position:fixed; top:50px; right:20px; font-size:14px; color:#ffffff;">版本: V0.07</div>
</div>
<br>
<div id="game-container">
    <div id="table">
        <div id="dealerHand" class="hand"></div>
        <div id="dealerMeldArea"></div>
        <div id="discardArea"></div>
        <div id="tableMessage" class="messageLayer" style="top: 35%; white-space: pre-wrap;"></div>
        <div id="dealerMessage" class="messageLayer" style="top:120px"></div>
        <div id="playerMessage" class="messageLayer" style="bottom:120px"></div>
        <div id="playerMeldArea"></div>
        <div id="playerHand" class="hand"></div>
        <div id="chiChoices"></div>
        <div id="diceContainer" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); gap:20px; z-index:3000;">
            <img id="dice1" style="width:70px;" src="images/1.png">
            <img id="dice2" style="width:70px;" src="images/1.png">
        </div>
    </div>

    <div id="controls">
        <span id="moneyDisplay" style="font-weight:bold; font-size:18px; margin-right:10px; min-width:130px; display:inline-block;">籌碼: $10000</span>
        <button id="rollDiceBtn">開始</button>
        <button id="drawBtn" class="disabled">摸牌</button>
        <button id="chiBtn" class="disabled">吃</button>
        <button id="pengBtn" class="disabled">碰</button>
        <button id="gangBtn" class="disabled">槓</button>
        <button id="huBtn" class="disabled">胡牌</button>
        <span style="font-size: 14px; margin-left:10px;">牌堆:<b id="deckCount">0</b></span>
    </div>
</div>

<script>
// Web Audio API 初始化
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
const soundBuffers = {};

async function loadSfx(name, url) {
    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const decodedData = await audioCtx.decodeAudioData(arrayBuffer);
        soundBuffers[name] = decodedData;
    } catch (e) { console.log(`Failed to load sound: ${name}`); }
}

loadSfx('roll', 'dice roll.mp3');
loadSfx('discard', 'dealing_cards1.mp3');
loadSfx('win', 'cheers2.mp3');

function playSfx(name) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (soundBuffers[name]) {
        const source = audioCtx.createBufferSource();
        source.buffer = soundBuffers[name];
        source.connect(audioCtx.destination);
        source.start(0);
    }
}

const allTileNames = [
    '1萬','2萬','3萬','4萬','5萬','6萬','7萬','8萬','9萬',
    '1筒','2筒','3筒','4筒','5筒','6筒','7筒','8筒','9筒',
    '1條','2條','3條','4條','5條','6條','7條','8條','9條',
    '東','南','西','北','中','發','白','back','1','2','3','4','5','6'
];
const imageCache = {};
function preloadImages() {
    allTileNames.forEach(name => {
        const img = new Image();
        img.src = `images/${name}.png`;
        imageCache[name] = img;
    });
}
preloadImages();

function autoScale() {
    const container = document.getElementById('game-container');
    const windowW = window.innerWidth;
    const windowH = window.innerHeight;
    const contentW = 980; 
    const contentH = 750; 
    const scale = Math.min(windowW / contentW, windowH / contentH);
    container.style.transform = `scale(${scale})`;
    container.style.marginTop = `${(windowH - contentH * scale) / 2}px`;
}
window.addEventListener('resize', autoScale);
window.addEventListener('orientationchange', autoScale);
autoScale();

const $ = id => document.getElementById(id);
$('backBtn').onclick=()=>{window.history.back();};

let deck=[], playerHand=[], dealerHand=[], playerMelds=[], dealerMelds=[];
let playerMoney = 10000, initialDealt = false, isDealing = false;
let playerTurn=true, hasDrawnThisTurn=false, lastDiscardedTile=null;
let tempDraw=null, dealerTempDraw=null;
let gameTurn = 0, isDealerFirst = true, dealerCount = 0;

function showMsg(layer, text, autoHide = true) {
    layer.textContent = text; layer.style.opacity = 1;
    if (autoHide) {
        setTimeout(() => {
            if (layer.textContent === text) layer.style.opacity = 0;
        }, 3000);
    }
}

function initDeck() {
    const suits=['萬','筒','條'], nums=[1,2,3,4,5,6,7,8,9], honors=['東','南','西','北','中','發','白'];
    deck = [];
    suits.forEach(s=>nums.forEach(n=>{for(let i=0;i<4;i++)deck.push(`${n}${s}`)}));
    honors.forEach(h=>{for(let i=0;i<4;i++)deck.push(h)});
    deck.sort(()=>Math.random()-0.5);
}

function sortHand(h){
    const o={'萬':1,'筒':2,'條':3,'東':4,'南':5,'西':6,'北':7,'中':8,'發':9,'白':10};
    return h.slice().sort((a,b)=>{
        const ma = a.match(/(\d)?(.+)/), mb = b.match(/(\d)?(.+)/);
        return o[ma[2]]-o[mb[2]] || (parseInt(ma[1])||0)-(parseInt(mb[1])||0);
    });
}

function updateUI() {
    $('playerHand').innerHTML = ''; $('dealerHand').innerHTML = '';
    const gap = 46;
    playerHand.forEach((t, i) => {
        const img = document.createElement('img'); img.src = `images/${t}.png`;
        img.style.left = `${i*gap}px`; img.onclick = () => playTile(i);
        $('playerHand').appendChild(img);
    });
    if(tempDraw) {
        const img = document.createElement('img'); img.src = `images/${tempDraw}.png`;
        img.style.left = `${playerHand.length*gap + 15}px`; img.onclick = () => playTile('temp');
        $('playerHand').appendChild(img);
    }
    dealerHand.forEach((t, i) => {
        const img = document.createElement('img'); img.src = `images/back.png`;
        img.style.left = `${i*gap}px`; $('dealerHand').appendChild(img);
    });
    if(dealerTempDraw) {
        const img = document.createElement('img'); img.src = `images/back.png`; 
        img.style.left = `-60px`; $('dealerHand').appendChild(img);
    }
    $('deckCount').textContent = deck.length;
    $('moneyDisplay').textContent = `籌碼: $${playerMoney}`;
    
    const canRespond = initialDealt && playerTurn && !hasDrawnThisTurn && lastDiscardedTile;
    $('drawBtn').className = (initialDealt && playerTurn && !hasDrawnThisTurn) ? '' : 'disabled';
    $('pengBtn').className = (canRespond && playerHand.filter(t=>t===lastDiscardedTile).length >= 2) ? '' : 'disabled';
    $('chiBtn').className = (canRespond && checkChiAvailable(lastDiscardedTile)) ? '' : 'disabled';
    
    let canGang = (canRespond && playerHand.filter(t=>t===lastDiscardedTile).length === 3) || 
                  (hasDrawnThisTurn && checkSelfGangAvailable());
    $('gangBtn').className = canGang ? '' : 'disabled';
    $('huBtn').className = (initialDealt && playerTurn) ? '' : 'disabled';
    
    $('rollDiceBtn').className = (initialDealt || isDealing) ? 'disabled' : '';
}

function checkSelfGangAvailable() {
    let combined = [...playerHand]; if(tempDraw) combined.push(tempDraw);
    let counts = {}; combined.forEach(t => counts[t] = (counts[t]||0)+1);
    for(let t in counts) if(counts[t] === 4) return true;
    if(tempDraw && playerMelds.some(m => m.type === 'pong' && m.tiles[0] === tempDraw)) return true;
    return false;
}

$('gangBtn').onclick = () => {
    if($('gangBtn').classList.contains('disabled')) return;
    let gangTile = "";
    if (lastDiscardedTile && !hasDrawnThisTurn) {
        gangTile = lastDiscardedTile;
        playerHand = playerHand.filter(t => t !== gangTile);
        playerMelds.push({type:'gang', tiles:[gangTile,gangTile,gangTile,gangTile]});
        addMeldUI('playerMeldArea', [gangTile,gangTile,gangTile,gangTile]);
        lastDiscardedTile = null;
    } else {
        let combined = [...playerHand]; if(tempDraw) combined.push(tempDraw);
        let counts = {}; combined.forEach(t => counts[t] = (counts[t]||0)+1);
        for(let t in counts) {
            if(counts[t] === 4) {
                gangTile = t; playerHand = combined.filter(tile => tile !== gangTile);
                tempDraw = null;
                playerMelds.push({type:'angang', tiles:[gangTile,gangTile,gangTile,gangTile]});
                addMeldUI('playerMeldArea', [gangTile,gangTile,gangTile,gangTile]);
                break;
            }
        }
        if(!gangTile && tempDraw) {
            let meldIdx = playerMelds.findIndex(m => m.type === 'pong' && m.tiles[0] === tempDraw);
            if(meldIdx !== -1) {
                gangTile = tempDraw;
                playerMelds[meldIdx] = {type:'gang', tiles:[gangTile,gangTile,gangTile,gangTile]};
                tempDraw = null;
                $('playerMeldArea').innerHTML = '';
                playerMelds.forEach(m => addMeldUI('playerMeldArea', m.tiles));
            }
        }
    }
    if(gangTile) {
        showMsg($('playerMessage'), "槓！");
        setTimeout(() => { 
            if(deck.length === 0) {
                showMsg($('tableMessage'), "流局！牌堆已空", false);
                initialDealt = false; updateUI(); return;
            }
            tempDraw = deck.pop(); hasDrawnThisTurn = true; updateUI(); 
        }, 500);
    }
};

function settleGame(winner, isSelfDraw) {
    let rawHand = (winner === 'player') ? [...playerHand] : [...dealerHand];
    let melds = (winner === 'player') ? playerMelds : dealerMelds;
    let lastTile = isSelfDraw ? (winner === 'player' ? tempDraw : dealerTempDraw) : lastDiscardedTile;
    rawHand.push(lastTile);
    let result = calculateTai(winner, rawHand, melds, isSelfDraw, lastTile);
    let totalMoney = 500 + (result.tai * 200);
    
    if (winner === 'player') { 
        playerMoney += totalMoney; 
        if (!isDealerFirst) dealerCount++; else dealerCount = 0; 
        playSfx('win'); 
    }
    else { 
        playerMoney -= totalMoney; 
        if (isDealerFirst) dealerCount++; else dealerCount = 0; 
    }
    
    showMsg($('tableMessage'), `${winner==='player'?'玩家':'莊家'} ${isSelfDraw?'自摸':'胡牌'}！\n${result.tai} 台 (${result.details.join(', ')})\n$${totalMoney}`, false);
    
    initialDealt = false; isDealing = false;
    tempDraw = null; 
    dealerTempDraw = null;
    lastDiscardedTile = null;
    updateUI();
}

function calculateTai(winner, fullHand, melds, isSelfDraw, lastTile) {
    let tai = 0, details = [];
    let counts = {}; fullHand.forEach(t => counts[t] = (counts[t]||0)+1);
    
    if ((winner === 'player' && !isDealerFirst) || (winner === 'dealer' && isDealerFirst)) {
        tai += 1; details.push("莊家");
        if (dealerCount > 0) { tai += (dealerCount * 2); details.push(`連莊${dealerCount}`); }
    }
    if (isSelfDraw) { tai += 1; details.push("自摸"); }
    if (melds.length === 0) { tai += 1; details.push("門清"); if(isSelfDraw) { tai += 1; details.push("不求人"); } }
    ['中', '發', '白'].forEach(h => { if (counts[h] >= 3) { tai += 1; details.push(h); } });
    
    let internalTriplets = 0;
    for(let t in counts) { if(counts[t] >= 3) { if(!isSelfDraw && t === lastTile) continue; internalTriplets++; } }
    if(internalTriplets === 3) { tai += 2; details.push("三暗刻"); }
    else if(internalTriplets === 4) { tai += 5; details.push("四暗刻"); }
    else if(internalTriplets === 5) { tai += 8; details.push("五暗刻"); }
    
    if (Object.values(counts).filter(v => v >= 3).length + melds.filter(m=>m.type!=='chi').length === 5) { tai += 4; details.push("碰碰胡"); }
    
    let suits = new Set(); 
    fullHand.forEach(t => { 
        let m = t.match(/萬|筒|條/);
        if(m) suits.add(m[0]); 
    });
    if (suits.size === 1) {
        if (!fullHand.some(t => !t.match(/\d/))) { tai += 8; details.push("清一色"); }
        else { tai += 4; details.push("混一色"); }
    }
    
    return { tai, details };
}

$('rollDiceBtn').onclick = () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    if(initialDealt || isDealing) return;
    isDealing = true; 
    $('rollDiceBtn').className = 'disabled'; 

    $('tableMessage').style.opacity = 0;
    $('playerHand').innerHTML = ''; $('dealerHand').innerHTML = ''; $('discardArea').innerHTML = '';
    $('playerMeldArea').innerHTML = ''; $('dealerMeldArea').innerHTML = '';
    
    initDeck(); 
    playerHand=[]; dealerHand=[]; playerMelds=[]; dealerMelds=[]; gameTurn = 0;
    tempDraw = null; dealerTempDraw = null;

    const startDeal = () => {
        showMsg($('tableMessage'), isDealerFirst ? "對方為莊家" : "你是莊家");
        for(let i=0; i<16; i++) { playerHand.push(deck.pop()); dealerHand.push(deck.pop()); }
        playerHand = sortHand(playerHand); dealerHand = sortHand(dealerHand);
        initialDealt = true; isDealing = false;
        if(isDealerFirst) {
            playerTurn = false; setTimeout(dealerAction, 1000);
        } else {
            playerTurn = true; hasDrawnThisTurn = false;
        }
        updateUI();
    };

    if (!isDealerFirst && dealerCount > 0) {
        startDeal();
    } else {
        showMsg($('tableMessage'), "新局開始，擲骰中...");
        playSfx('roll'); 
        $('diceContainer').style.display = 'flex';
        let count = 0;
        const interval = setInterval(() => {
            const r1 = Math.floor(Math.random()*6)+1, r2 = Math.floor(Math.random()*6)+1;
            $('dice1').src = `images/${r1}.png`; $('dice2').src = `images/${r2}.png`;
            if (++count > 10) {
                clearInterval(interval); 
                setTimeout(() => { 
                    $('diceContainer').style.display = 'none';
                    isDealerFirst = ((r1+r2)%2 !== 0);
                    startDeal();
                }, 800);
            }
        }, 100);
    }
};

$('drawBtn').onclick = () => {
    if($('drawBtn').classList.contains('disabled')) return;
    if (deck.length === 0) {
        showMsg($('tableMessage'), "流局！牌堆已空", false);
        initialDealt = false; updateUI(); return;
    }
    tempDraw = deck.pop(); hasDrawnThisTurn = true; lastDiscardedTile = null; updateUI();
};

function playTile(index) {
    if(!playerTurn || !hasDrawnThisTurn) return;
    let t = (index === 'temp') ? tempDraw : playerHand.splice(index, 1)[0];
    if(index !== 'temp' && tempDraw) { playerHand.push(tempDraw); }
    tempDraw = null; playerHand = sortHand(playerHand);
    const img = document.createElement('img'); img.src = `images/${t}.png`; img.className = 'discardTile';
    $('discardArea').appendChild(img);
    playSfx('discard'); 
    lastDiscardedTile = t; playerTurn = false; hasDrawnThisTurn = false;
    updateUI(); setTimeout(() => dealerResponse(t), 800);
}

$('pengBtn').onclick = () => {
    const t = lastDiscardedTile;
    playerHand.splice(playerHand.indexOf(t), 1); playerHand.splice(playerHand.indexOf(t), 1);
    playerMelds.push({type:'pong', tiles:[t,t,t]}); addMeldUI('playerMeldArea', [t,t,t]);
    lastDiscardedTile = null; playerTurn = true; hasDrawnThisTurn = true; updateUI();
};

$('chiBtn').onclick = () => {
    const t = lastDiscardedTile; const m = t.match(/^(\d)([萬筒條])$/); if(!m) return;
    const n = parseInt(m[1]), s = m[2];
    const patterns = [[n-2, n-1], [n-1, n+1], [n+1, n+2]];
    $('chiChoices').innerHTML = '';
    patterns.forEach(p => {
        const p1 = `${p[0]}${s}`, p2 = `${p[1]}${s}`;
        if(playerHand.includes(p1) && playerHand.includes(p2)) {
            const div = document.createElement('div'); div.className = 'chi-group';
            [p1, t, p2].sort().forEach(src => {
                const img = document.createElement('img'); img.src = `images/${src}.png`;
                img.style.width = '44px'; div.appendChild(img);
            });
            div.onclick = () => {
                playerHand.splice(playerHand.indexOf(p1), 1); playerHand.splice(playerHand.indexOf(p2), 1);
                const combined = sortHand([p1, t, p2]);
                playerMelds.push({type:'chi', tiles: combined}); addMeldUI('playerMeldArea', combined);
                lastDiscardedTile = null; playerTurn = true; hasDrawnThisTurn = true;
                $('chiChoices').style.display = 'none'; updateUI();
            };
            $('chiChoices').appendChild(div);
        }
    });
    $('chiChoices').style.display = 'flex';
};

$('huBtn').onclick = () => {
    let tiles = [...playerHand]; if (hasDrawnThisTurn) tiles.push(tempDraw); else tiles.push(lastDiscardedTile);
    if (checkWin(tiles)) settleGame('player', hasDrawnThisTurn);
    else showMsg($('playerMessage'), "沒胡喔");
};

function dealerResponse(tile) {
    if (checkWin([...dealerHand, tile])) { settleGame('dealer', false); return; }
    let count = dealerHand.filter(x => x === tile).length;
    if (count >= 3) {
        dealerHand = dealerHand.filter(x => x !== tile);
        dealerMelds.push({type:'gang', tiles:[tile,tile,tile,tile]});
        addMeldUI('dealerMeldArea', [tile,tile,tile,tile]);
        dealerAction(); return;
    } else if (count >= 2) {
        dealerHand = dealerHand.filter(x => x !== tile);
        dealerMelds.push({type:'pong', tiles:[tile,tile,tile]});
        addMeldUI('dealerMeldArea', [tile,tile,tile]);
        dealerDiscard(); return;
    }
    dealerAction();
}

function dealerAction() {
    if(deck.length === 0) { 
        showMsg($('tableMessage'), "流局！牌堆已空", false); 
        initialDealt = false; isDealing = false; updateUI(); return; 
    }
    dealerTempDraw = deck.pop(); updateUI();
    setTimeout(() => {
        if (checkWin([...dealerHand, dealerTempDraw])) { settleGame('dealer', true); return; }
        let counts = {}; [...dealerHand, dealerTempDraw].forEach(t => counts[t] = (counts[t]||0)+1);
        for(let t in counts) if(counts[t] === 4) {
            dealerHand = [...dealerHand, dealerTempDraw].filter(tile => tile !== t);
            dealerTempDraw = null; dealerMelds.push({type:'angang', tiles:[t,t,t,t]});
            addMeldUI('dealerMeldArea', [t,t,t,t]); dealerAction(); return;
        }
        dealerHand.push(dealerTempDraw); dealerTempDraw = null; dealerHand = sortHand(dealerHand); dealerDiscard();
    }, 1000);
}

function dealerDiscard() {
    let discardIdx = Math.floor(Math.random() * dealerHand.length);
    const t = dealerHand.splice(discardIdx, 1)[0];
    const img = document.createElement('img'); img.src = `images/${t}.png`; img.className = 'discardTile';
    $('discardArea').appendChild(img);
    playSfx('discard'); 
    lastDiscardedTile = t; playerTurn = true; updateUI();
}

function checkWin(hand) {
    if (hand.length % 3 !== 2) return false;
    let counts = {}; hand.forEach(t => counts[t] = (counts[t]||0)+1);
    for (let t in counts) if (counts[t] >= 2) { counts[t] -= 2; if (canExhaust(counts)) return true; counts[t] += 2; }
    return false;
}

function canExhaust(counts) {
    let tiles = Object.keys(counts).filter(t => counts[t] > 0).sort(); if (tiles.length === 0) return true;
    let f = tiles[0];
    if (counts[f] >= 3) { counts[f] -= 3; if (canExhaust(counts)) return true; counts[f] += 3; }
    let m = f.match(/^(\d)([萬筒條])$/);
    if (m) {
        let n=parseInt(m[1]), s=m[2], t2=`${n+1}${s}`, t3=`${n+2}${s}`;
        if (n<=7 && counts[t2]>0 && counts[t3]>0) {
            counts[f]--; counts[t2]--; counts[t3]--; if (canExhaust(counts)) return true;
            counts[f]++; counts[t2]++; counts[t3]++;
        }
    }
    return false;
}

function checkChiAvailable(tile) {
    let m = tile.match(/^(\d)([萬筒條])$/); if(!m) return false;
    let n=parseInt(m[1]), s=m[2];
    return [[n-2,n-1],[n-1,n+1],[n+1,n+2]].some(p => playerHand.includes(`${p[0]}${s}`) && playerHand.includes(`${p[1]}${s}`));
}

function addMeldUI(target, tiles) {
    const group = document.createElement('div'); group.className = 'meldGroup';
    tiles.forEach(t => { const img = document.createElement('img'); img.src = `images/${t}.png`; group.appendChild(img); });
    $(target).appendChild(group);
}
window.addEventListener('touchstart', (e) => { if (e.target.id === 'table') $('chiChoices').style.display = 'none'; });
</script>
</body>
</html>