<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>德州撲克對戰</title>
<style>
body { font-family: Arial; text-align: center; margin-top: 10px; background: transparent; color: white;}
h1 { margin-bottom: 10px; color: #333333; }

.card { 
    width: 70px; height: 100px; border-radius: 8px; border: 1px solid #333;
    display: flex; align-items: center; justify-content: center; font-size: 24px;
    background-color: white; color: black; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    position: absolute;
    z-index: 10;
    cursor: pointer;
}
.back { background-color: gray; color: gray; }
.red { color: red; }

#table-container { position: relative; margin: 20px auto; width: 750px; height: 400px; }
#table { width: 100%; height: 100%; background: #228B22; border: 20px solid #8B4513; box-sizing: border-box; position: absolute; top: 0; left: 0; z-index: 1; border-radius: 200px / 50%; }

#messageResult { position:absolute; top:50%; left:15%; transform:translateY(-50%); font-size:28px; color:yellow; font-weight:bold; text-shadow:2px 2px 5px black; z-index:11; }
#messageMary { position:absolute; top:37%; right:47%; font-size:24px; color:yellow; font-weight:bold; text-shadow:2px 2px 5px black; z-index:11; }
#messagePlayer { position:absolute; bottom:37%; right:47%; font-size:24px; color:yellow; font-weight:bold; text-shadow:2px 2px 5px black; z-index:11; }

button { padding: 4px 16px; font-size: 14px; margin: 10px; border-radius: 5px; cursor: pointer; background: linear-gradient(to bottom, #f0f0f0, #ccc); border: 1px solid #888; box-shadow: 2px 2px #dddddd; transition: all 0.1s ease-in-out; }
button:active { box-shadow: 2px 2px #eeeeee; transform: translateY(2px); }
button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }

select { font-size: 16px; padding: 5px; margin-right: 5px; }

#betContainer { position: relative; z-index: 12; margin: 20px auto; color: #333333; }

#backBtn{ position:fixed; top:10px; right:10px; padding:6px 12px; font-size:14px; background:#fff; border:2px solid #ccc; border-radius:6px; cursor:pointer; color:#333; z-index:9999; box-shadow: 2px 2px #dddddd; }
#backBtn:active { box-shadow: 2px 2px #eeeeee; transform: translateY(2px); }

#chipBox { display: inline-block; padding: 3px 3px; min-width: 30px; border: 1px solid #333; border-radius: 4px; margin-bottom: 2px; font-weight: bold; font-size:20px; color: #333; background-color: rgba(255,255,255,0.1); position: relative; text-align: center; }

#warningMessage { font-size: 18px; color: red; font-weight: bold; position: absolute; left: 50%; transform: translateX(-50%); bottom: 82%; margin-bottom: 4px; white-space: nowrap; display: none; }
</style>
</head>
<body>

<button id="backBtn">回到上一頁</button>
<div id="version" style="position:fixed; top:60px; right:25px; font-size:14px; color:#333333;">版本: V0.05</div>

<h1>新德州撲克</h1>

<div id="table-container">
    <div id="table"></div>
    <div id="computer-hand"></div>
    <div id="player-hand"></div>
    <div id="messageResult"></div>
    <div id="messageMary"></div>
    <div id="messagePlayer"></div>
</div>

<div id="betContainer">
    <button id="addCoinBtn">投幣10元</button>
    籌碼: <div id="chipBox">00000</div>
    <div id="warningMessage">錢不夠了</div>
    下注金額:
    <select id="betAmount">
        <option value="10">10</option>
        <option value="50">50</option>
        <option value="100">100</option>
        <option value="500">500</option>
        <option value="1000">1000</option>
    </select>
    <button id="betBtn">下注</button>
    <button id="newGameBtn" disabled>發牌</button>
    <button id="swapBtn" disabled>換牌</button>
    <button id="revealBtn" disabled>攤牌</button>
</div>

<script>
backBtn.onclick=()=>{window.history.back();};

let chips = 0, currentBet = 0, selectedCards = [], swapUsed = false, coinPressCount = 0;
const maxCoinPress = 10;

let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let coinBuffer = null;
let dealingBuffer = null;
let winBuffer = null;
let loseBuffer = null;

// 載入音效
function loadAudio(url, callback) {
    fetch(url)
        .then(r => r.arrayBuffer())
        .then(buf => audioContext.decodeAudioData(buf))
        .then(decoded => callback(decoded))
        .catch(err => console.error("音效載入失敗", err));
}

loadAudio('coin07.mp3', buf => coinBuffer = buf);
loadAudio('dealing_cards1.mp3', buf => dealingBuffer = buf);
loadAudio('cheers2.mp3', buf => winBuffer = buf);
loadAudio('you-lose1.mp3', buf => loseBuffer = buf);

function playSound(buffer){
    if(!buffer) return;
    if(audioContext.state === 'suspended') audioContext.resume();
    let source = audioContext.createBufferSource();
    source.buffer = buffer;
    source.connect(audioContext.destination);
    source.start(0);
}

function updateChipsDisplay(){document.getElementById("chipBox").textContent = String(chips).padStart(5,'0');}
function showWarningMessage(msg){const w = document.getElementById("warningMessage"); w.textContent = msg; w.style.display = "block"; setTimeout(()=>{ w.style.display="none"; },3000);}

// 投幣10元
document.getElementById("addCoinBtn").addEventListener("click", ()=>{
    if(coinPressCount >= maxCoinPress) return;
    chips += 10;
    coinPressCount++;
    updateChipsDisplay();
    playSound(coinBuffer);
    if(coinPressCount >= maxCoinPress){
        document.getElementById("addCoinBtn").disabled = true;
    }
});

const suits=["♠","♥","♦","♣"], values=["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
function createDeck(){let deck=[];for(let s of suits){for(let v of values){deck.push({value:v,suit:s});}}return deck;}
function drawCards(deck,count){let hand=[];for(let i=0;i<count;i++){let idx=Math.floor(Math.random()*deck.length);hand.push(deck.splice(idx,1)[0]);}return hand;}
function cardValue(c){if(c.value==="J")return 11;if(c.value==="Q")return 12;if(c.value==="K")return 13;if(c.value==="A")return 14;return parseInt(c.value);}
function valueToFace(val){if(val===14)return "A";if(val===13)return "K";if(val===12)return "Q";if(val===11)return "J";return val.toString();}
function evaluateHand(hand){
    let vals=hand.map(c=>cardValue(c)).sort((a,b)=>a-b), suitsArr=hand.map(c=>c.suit), counts={};
    vals.forEach(v=>counts[v]=(counts[v]||0)+1);
    let isFlush=suitsArr.every(s=>s===suitsArr[0]), isStraight=vals[4]-vals[0]===4&&new Set(vals).size===5;
    let score=0,tiebreaker=[],handName="";
    let countVals=Object.entries(counts).sort((a,b)=>{if(b[1]===a[1])return b[0]-a[0];return b[1]-a[1];}).map(x=>parseInt(x[0]));
    if(isFlush && isStraight && vals[4]===14){score=10;handName="皇家同花順";}
    else if(isFlush && isStraight){score=9;handName="同花順";}
    else if(Object.values(counts).includes(4)){score=8;handName="四條";}
    else if(Object.values(counts).includes(3) && Object.values(counts).includes(2)){score=7;handName="葫蘆";}
    else if(isFlush){score=6;handName="同花";}
    else if(isStraight){score=5;handName="順子";}
    else if(Object.values(counts).includes(3)){score=4;handName="三條";}
    else if(Object.values(counts).filter(x=>x===2).length===2){score=3;handName="兩對";}
    else if(Object.values(counts).includes(2)){score=2;let pairVal=Object.entries(counts).find(([k,v])=>v===2)[0];handName="一對 "+valueToFace(parseInt(pairVal));}
    else{score=1;let maxVal=Math.max(...vals);let maxCard=hand.find(c=>cardValue(c)===maxVal);handName="最大 "+valueToFace(maxVal)+maxCard.suit;}
    tiebreaker=countVals.slice(); return {score,tiebreaker,handName};
}
function compareHands(h1,h2){let a=evaluateHand(h1),b=evaluateHand(h2);if(a.score>b.score)return {result:1,hand1Name:a.handName,hand2Name:b.handName}; if(a.score<b.score)return {result:-1,hand1Name:a.handName,hand2Name:b.handName}; for(let i=0;i<a.tiebreaker.length;i++){if(a.tiebreaker[i]>b.tiebreaker[i])return {result:1,hand1Name:a.handName,hand2Name:b.handName}; if(a.tiebreaker[i]<b.tiebreaker[i])return {result:-1,hand1Name:a.handName,hand2Name:b.handName};} return {result:0,hand1Name:a.handName,hand2Name:b.handName};}

const playerPositions=[{top:"260px",left:"170px"},{top:"260px",left:"250px"},{top:"260px",left:"330px"},{top:"260px",left:"410px"},{top:"260px",left:"490px"}];
const computerPositions=[{top:"40px",left:"170px"},{top:"40px",left:"250px"},{top:"40px",left:"330px"},{top:"40px",left:"410px"},{top:"40px",left:"490px"}];

function showSingleCard(card,elementId,index,hide){
    const container=document.getElementById(elementId);
    const positions=elementId==="player-hand"?playerPositions:computerPositions;
    let div=document.createElement("div");
    div.className="card"+(hide?" back":"");
    div.textContent=hide?"":card.value+card.suit;
    if(!hide&&(card.suit==="♥"||card.suit==="♦"))div.classList.add("red");
    div.style.top=positions[index].top;
    div.style.left=positions[index].left;
    if(elementId==="player-hand"){div.addEventListener("click",()=>{if(swapUsed||document.getElementById("swapBtn").disabled)return;if(div.style.border==="3px solid red"){div.style.border="1px solid #333";selectedCards=selectedCards.filter(i=>i!==index);}else{if(selectedCards.length>=2){showWarningMessage("最多只能選2張牌");return;} div.style.border="3px solid red";selectedCards.push(index);}});}
    container.appendChild(div);
}

let playerHand=[],maryHand=[],deck=[];
async function dealCardsAnimation(){
    deck=createDeck();playerHand=drawCards(deck,5);maryHand=drawCards(deck,5);
    document.getElementById("player-hand").innerHTML="";
    document.getElementById("computer-hand").innerHTML="";
    document.getElementById("messageResult").textContent="";
    document.getElementById("messageMary").textContent="";
    document.getElementById("messagePlayer").textContent="";
    for(let i=0;i<5;i++){
        showSingleCard(playerHand[i],"player-hand",i,false); 
        playSound(dealingBuffer);
        await new Promise(r=>setTimeout(r,300)); 
        showSingleCard(maryHand[i],"computer-hand",i,true); 
        playSound(dealingBuffer);
        await new Promise(r=>setTimeout(r,300));
    }
    setTimeout(()=>{
        const sortOrder=["A","2","3","4","5","6","7","8","9","10","J","Q","K"],suitOrder=["♠","♥","♦","♣"];
        playerHand.sort((a,b)=>a.value===b.value?suitOrder.indexOf(a.suit)-suitOrder.indexOf(b.suit):sortOrder.indexOf(a.value)-sortOrder.indexOf(b.value));
        maryHand.sort((a,b)=>a.value===b.value?suitOrder.indexOf(a.suit)-suitOrder.indexOf(b.suit):sortOrder.indexOf(a.value)-sortOrder.indexOf(b.value));
        document.getElementById("player-hand").innerHTML="";
        document.getElementById("computer-hand").innerHTML="";
        for(let i=0;i<5;i++){showSingleCard(playerHand[i],"player-hand",i,false); showSingleCard(maryHand[i],"computer-hand",i,true);}
        document.getElementById("swapBtn").disabled=false;
        document.getElementById("revealBtn").disabled=false;
    },1000);
}

// 下注
document.getElementById("betBtn").addEventListener("click",()=>{
    let bet=parseInt(document.getElementById("betAmount").value);
    if(bet>chips){showWarningMessage("錢不夠了"); return;}
    chips-=bet; currentBet=bet; updateChipsDisplay();
    document.getElementById("player-hand").innerHTML="";
    document.getElementById("computer-hand").innerHTML="";
    document.getElementById("messageResult").textContent="";
    document.getElementById("messageMary").textContent="";
    document.getElementById("messagePlayer").textContent="";
    document.getElementById("betBtn").disabled=true;
    document.getElementById("newGameBtn").disabled=false;
    document.getElementById("revealBtn").disabled=true;
    document.getElementById("swapBtn").disabled=true;
    swapUsed=false;
    selectedCards=[];
});

// 換牌
document.getElementById("swapBtn").addEventListener("click", async ()=>{
    if(swapUsed){showWarningMessage("換牌只能使用一次");return;}
    if(selectedCards.length===0){showWarningMessage("請先點選最多2張撲克牌");return;}
    swapUsed=true;
    document.getElementById("swapBtn").disabled=true;
    document.getElementById("revealBtn").disabled=true;
    for(let idx of selectedCards){
        const cardDiv=document.querySelectorAll("#player-hand .card")[idx];
        cardDiv.classList.add("back"); cardDiv.textContent="";
    }
    await new Promise(r=>setTimeout(r,1000));
    for(let idx of selectedCards){
        playerHand[idx]=drawCards(deck,1)[0];
        const cardDiv=document.querySelectorAll("#player-hand .card")[idx];
        cardDiv.classList.remove("back");
        cardDiv.textContent=playerHand[idx].value+playerHand[idx].suit;
        if(playerHand[idx].suit==="♥"||playerHand[idx].suit==="♦") cardDiv.classList.add("red"); else cardDiv.classList.remove("red");
        cardDiv.style.border="1px solid #333";
    }
    selectedCards=[];
    setTimeout(()=>{
        const sortOrder=["A","2","3","4","5","6","7","8","9","10","J","Q","K"], suitOrder=["♠","♥","♦","♣"];
        playerHand.sort((a,b)=>a.value===b.value?suitOrder.indexOf(a.suit)-suitOrder.indexOf(b.suit):sortOrder.indexOf(a.value)-sortOrder.indexOf(b.value));
        document.getElementById("player-hand").innerHTML="";
        for(let i=0;i<5;i++){showSingleCard(playerHand[i],"player-hand",i,false);}
        document.getElementById("revealBtn").disabled=false;
    },2000);
});

// 發牌
document.getElementById("newGameBtn").addEventListener("click", async ()=>{
    document.getElementById("newGameBtn").disabled=true; 
    document.getElementById("addCoinBtn").disabled=true; 
    await dealCardsAnimation();
});

// 攤牌
document.getElementById("revealBtn").addEventListener("click",()=>{
    const computerCards=document.querySelectorAll("#computer-hand .card");
    for(let i=0;i<5;i++){
        computerCards[i].textContent=maryHand[i].value+maryHand[i].suit;
        computerCards[i].classList.remove("back");
        if(maryHand[i].suit==="♥"||maryHand[i].suit==="♦") computerCards[i].classList.add("red"); else computerCards[i].classList.remove("red");
    }
    const playerCards=document.querySelectorAll("#player-hand .card");
    playerCards.forEach(c=>c.style.border="1px solid #333");
    document.getElementById("swapBtn").disabled=true;
    let res=compareHands(playerHand,maryHand);
    let resultText=res.result===1?`你贏了 ${currentBet*2} 元`:(res.result===-1?`你輸了 ${currentBet} 元`:"平手");
    document.getElementById("messageResult").textContent=resultText;
    document.getElementById("messageMary").textContent=` ${res.hand2Name}`;
    document.getElementById("messagePlayer").textContent=` ${res.hand1Name}`;
    if(res.result===1){
        chips+=currentBet*2; 
        updateChipsDisplay();
        playSound(winBuffer);
    } else if(res.result===-1){
        playSound(loseBuffer);
    }
    currentBet=0;
    document.getElementById("betBtn").disabled=false;
    document.getElementById("revealBtn").disabled=true;
    swapUsed=true;
    selectedCards=[];
    if(chips===0){ coinPressCount=0; document.getElementById("addCoinBtn").disabled=false; }
});

updateChipsDisplay();
</script>
</body>
</html>
